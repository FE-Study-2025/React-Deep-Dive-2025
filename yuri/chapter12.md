# 12장 모든 웹 개발자가 관심을 가져야 할 핵심 웹 지표

## 12.1 웹사이트와 성능
사용자가 웹사이트에 접속했을 때 공통적으로 기대하는 사항
1. 웹사이트를 방문한 목적을 손쉽게 달성할 수 있어야 한다.
2. 웹사이트가 원하는 목적을 달성하는 데 걸리는 시간이 짧아야 한다.
3. 개인정보가 누출되는 등의 사고 없이 보안이 철저해야 한다.

각종 최신 기술이 집약된 사이트라 하더라도 결국은 사용자가 느끼는 성능이 제일 중요하다.

## 12.2 핵심 웹 지표란?
핵심 웹 지표(Core Web Vital)란 구글에서 만든 지표로, 웹사이트에서 뛰어난 사용자 경험을 제공하는 데 필수적인 지표를 일컫는 용어다.

### 1. 최대 콘텐트풀 페인트(LCP: Largest Contentful Paint)
웹사이트의 페이지가 처음으로 로드를 시작한 시점부터 뷰포트 내부에서 가장 큰 <b>"요소"</b>를 렌더링하는 데 걸리는 시간을 말한다.
- `<img>`
- `<svg>`내부의 `<image>`
- poster 속설을 사용하는 `<video>`
- url() 배경이미지 스타일이 있는 요소
- 텍스트와 같이 인라인 텍스트 요소를 포함하고 있는 블록 레벨 요소

#### 기준점수
- 좋음: 2.5초 이하
- 보통: 2.5초 ~ 4초
- 나쁨: 4초 초과

#### 개선 방안
- 추가적인 리소스 다운로드가 필요한 이미지보다 텍스트 노출이 훨씬 더 빠르다.
- 이미지를 노출해야 한다면 css background-image, svg 내부의 `<img>` 보다 `<img>`,`<video>`를 쓰자.
    - `<img>`,`<video>` 는 브라우저의 프리로드 스캐너에 의해 먼저 빠르게 리소스 다운로드 요청이 일어난다.
    - 프리로드 스캐너란 HTML을 파싱하는 단계를 차단하지 않고 미리 로딩하면 좋은 리소스를 먼저 찾아 로딩하는 브라우저의 기능.
    - svg 내부의 `<img>`는 프리로드 스캐너에 의해 발견되지 않아 병렬적으로 다운로드가 일어나지 않고, background-image 를 비롯한 CSS에 있는 리소스는 해당 리소스를 필요로하는 DOM을 그릴 준비가 될 때까지 요청을 대기한다.

#### 그 밖에 조심해야 할 사항
- 이미지 무손실 압축으로 최소한의 용량으로 서비스를 제공하는 것이 좋다.
- `loading=lazy`는 리소스를 중요하지 않음으로 표시하고 필요할 때만 로드하는 전략이므로, LCP 지표에 영향을 주는 이미지에는 사용하지 않는 것이 좋다.
- `fadeIn` 같은 각종 애니메이션 이미지에 딜레이 애니메이션 옵션이 있으면 그만큼 LCP도 늦어진다.
- `useEffect`와 같이 리액트 코드를 파싱하고 읽어서 API 요청을 보내고 응답받은 데이터로 LCP 영역의 노출을 제어하는 시나리오라면 그만큼 LCP도 늦어진다. 가능한 서버에서 미리 빌드된 채로 오는것이 좋다.
- 가능하다면 LCP 내 리소스는 같은 도메인에서 직접 호스팅하는 것이 좋다. 와전히 다른 출처의 경우 이미 연결이 맺어진 현재 출처와는 다르게, 네트워크 커넥션부터 다시 수행해야 하기 때문이다.



### 2. 최초 입력 지연(FID: First Input Delay)

웹사이트의 반응성을 측정하는 지표이다. 
화면이 최초에 그려지고 난 뒤, 사용자가 웹페이지에서 클릭 등 상호작용을 수행했을 때 메인 스레드가 이 이벤트에 대한 실행을 시작하는 데 걸리는 시간을 의미한다.

#### 기준점수
- 좋음: 100ms 이하
- 보통: 100ms ~ 300ms
- 나쁨: 300ms 초과

#### 개선 방안
1. 크롬 개발자 도구 성능 탭에서 CPU 성능을 의도적으로 떨어뜨려 테스트 후 너무 오래 걸리는 작업은 서버로 옮겨서 처리할 수 있을지 고려.
2. 실행에 오래 걸리는 긴 작업을 여러개로 분리해 본다. 일반적으로 크롬의 경우 50ms 이상 걸리면 오래 걸리는 작업이라고 간주하며, 최초 로딩에 필요하지 않은 내용은 나중에 불러오게 한다.
3. 번들링된 자바스크립트 코드에서도 당장 웹페이지를 불러오는 데 사용되지 않는 코드들은 지연로딩 기법 또는 사용자의 특정 이벤트에 의해 불러오거나, 우선순위를 낮춰서 불러오는 것이 좋다.
4. 타사 자바스크립트는 가능하면 `<script>`의 async 속성 또는 defer 속성을 사용해 다른 리소스와 함께 병렬로 다운로드한다. defer 속성의 스크립트의 실행은 페이지가 완전히 로딩된 이후에 맨 마지막에 실행되고, async 속성의 스크립트는 다운로드가 완료된 순서대로 실행된다.

### 3. 누적 레이아웃 이동(CLS: Cumulative Layout Shift)
페이지의 생명주기 동안 발생하는 모든 예기치 않은 이동에 대한 지표를 계산하는 것이 바로 누적 레이아웃 이동(CLS)이다. CLS는 사용자의 가시적인 콘텐츠에 영향을 미쳐야 하기 때문에 뷰포트 내부의 요소에 대해서만 측정하며, 뷰포트 밖의 요소에 대해서는 측정하지 않는다.

#### 기준점수
- 좋음: 0.1 이하
- 보통: 0.1 ~ 0.25
- 나쁨: 0.25 초과

#### 개선 방안
##### 1. 삽입이 예상되는 요소를 위한 추가적인 공간 확보
  - 스켈레톤 UI를 써서 동적으로 뜨는 영역 공간을 미리 확보해 두는 것도 방법
  - 동적 요소 유무를 사전에 판단해 클라이언트에 HTML을 미리 제공하는 서버 사이드 렌더링
  - useEffect 내부에서 뷰포트 내부에 노출될 요소에 대한 작업을 최소화 하는 것이 좋다.
##### 2. 폰트 로딩 최적화
  폰트로 발생할 수 있는 문제
  - `FOUT(Flash of Unstyled Text)`: 기본 폰트로 보이다가 뒤늦게 지정한 폰트가 적용되는 현상
  - `FOIT(Flash of Invisible Text)`: 기본 폰트도 없어서 텍스트가 없는 채로 있다가 뒤늦게 폰트가 로딩되면서 렌더링되는 현상
  
  폰트 로딩 최적화 방법
  - `<link rel="preload">` 태그를 사용해 폰트를 브라우저가 리소스를 더 빠르게 로드할 수 있도록 한다.
  - font-family: optional을 사용한다. 0.1초 이내 폰트가 다운로드되지 않으면 폴백 폰트를 사용하고, 네트워크 상태에 따라 일정 기간 폰트를 다운로드 하지 못한다면 연결을 취소한다.
##### 3. 적절한 이미지 크기 설정
  - 이미지 크기를 명시적으로 지정하면 브라우저가 이미지 로딩을 더 효율적으로 처리할 수 있다.
  - 다음 예제와 같이 `width: 100%; height: auto;` style과 함께 `<img>` 태그에 `width`, `height` 속성을 원하는 비율로 지정하면 브라우저가 이미지를 로딩하기 전에 적절한 가로세로 비율을 계산해 이미지가 표시되는 만큼 면적을 할당해 둔다. 이는 브라우저의 유저 에이전트 스타일시트에 `aspect-ratio` 속성에 의해서 이미지의 가로세로 비율을 자동으로 맞춰준다.

    ```jsx
    import './styles.css'; 

    export default function App() {
        return (
        <div className="App">
            <img src="/image.jpg" alt="image" width="1600" height="900" />
        </div>
        );
    }
    ```
  - 사용자 뷰포트 너비에 맞춰 다른 이미지를 제공하고 싶다면 `srcset` 속성을 사용하는 것이 좋다.

    ```html
    <img src="image-1600.jpg" alt="image" width="1600" height="900" srcset="image-1600.jpg 1600w, image-800.jpg 800w" />
    ```


## 12.3 핵심 웹 지표는 아니지만 성능 확인에 중요한 지표들

### 1. 최초 바이트까지 시간(TTFB: Time To First Byte)
페이지를 요청했을 때 최초의 응답이 오는 바이트까지가 얼마나 걸리는지를 측정하는 지표다. 600ms 이상 걸리면 개선이 필요함.

#### 개선 방안
- 서버 사이드 렌더링을 수행하고 있다면 페이지를 만드는 데 필요한 작업을 최소화하고, 페이지를 그리는 데 중요한 내용만 서버 사이드 렌더링에서 준비하는 등의 최적화가 필요하다.
- 서버 사이드 렌더링 시에 API 호출이 필요하다면 호출 횟수와 가져오는 정보의 크기를 최소화해서 최대한 최적화할 필요가 있다.
- 웹페이지릐 주된 방문객의 국적을 파악해 최대한 해당 국적과 가깝게 서버를 위치시키는 것이 좋다.
- 리액트 서버 사이드 렌더링이라면 스트리밍 API를 사용하여 최초 바이트까지의 시간을 단축시킬 수 있다.

### 2. 최초 콘텐츠풀 페인트(FCP: First Contentful Paint)
웹사이트가 처음 로드되고 콘텐츠의 일부가 렌더링될 때까지의 시간을 측정하는 지표다.
여기서 콘텐츠의 일부에 해당하는 요소는 텍스트, 이미지, svg 등을 의미한다.

#### 기준점수
- 좋음: 1.8초 이하
- 보통: 1.8초 ~ 3초
- 나쁨: 3초 초과

#### 개선 방안
- 최초 바이트까지 시간(TTFB)을 개선
- 자바스크립트나 CSS 같은 렌더링을 가로막는 리소스는 비동기적으로 로드되도록 한다.
- Above the Fold 영역에 게으른 로딩을 하거나 리액트의 useEffect와 같이 스크립트에 의존해 요소가 렌더링되는 것을 피해야 한다.
- 페이지 리다이렉트 최소화
- DOM 크기를 최소화한다. 구글 기준 전체 DOM 노드는 1500개 미만, 깊이는 32단계 정도까지만, 부모 노드는 자식 노드를 60개 정도만 가지고 있어야 한다.



