# 12장 - 모든 웹 개발자가 관심을 가져야 할 핵심 웹 지표

## 1 웹사이트와 성능
- 사용자가 웹사이트에 접속했을 때 기대하는 사항
  - 방문한 목적을 손쉽게 달성
  - 목적을 달성하는 데 걸리는 시간이 짧아야 하며
  - 웹사이트에서 개인정보가 누출되는 등의 사고 없이 보안이 철저
- 웹사이트의 성능에 영향을 미치는 요소
  - 1초 내로 로딩되는 사이트는 5초 내로 로딩되는 사이트보다 전자상거래 전환율이 2.5배 더 높다.
  - 0 ~ 5초의 범위에서, 1초 로딩이 늦어질수록 전환율은 4.42%씩 떨어진다.
  - 페이지 로드 시간이 0 ~ 2초 사이인 페이지에서 가장 높은 전환율을 달성할 수 있다.
- 구글이 요즘 웹사이트의 성능에 대해 남긴 글
> 전 세계 사용자의 대부분이 모바일을 3G가 아닌 4G로 사용하고 있음에도 불구하고, 대부분의 모바일 사이트는 여전히 느리고 너무 많은 요소 때문에 비대해졌다.


## 2 핵심 웹 지표란?
- 핵심 웹 지표(Core Web Vital)란 구글에서 만든 지표로, 쉡사이트에서 뛰어난 사용자 경험을 제공하는 데 필수적인 지표
  - 최대 콘텐츠풀 페인트(LCP - Largest Contentful Paint)
  - 최초 입력 지연(FID: First Input Delay)
  - 누적 레이아웃 이동(CLS: Cumulative Layout Shift)
- 특정 문제를 진단하는 데 사용될 수 있는 지표
  - 최초 바이트까지의 시간(TTFB: Time To First Byte)
  - 최초 콘텐츠풀 시간(FCP: First Contentful Paint)


## 3 최대 콘텐츠풀 페인트(LCP)

### 3.1 정의
- 페이지가 처음으로 로드를 시작한 시점부터 뷰표트 내부에서 사장 큰 이미지 또는 텍스트를 렌더링하는 데 걸리는 시간
- 로딩에 따라 변화하는 지표

### 3.2 의미
- 사용자에게 있어 로딩이란 뷰포트 영역에서 보이는 부분을 기준으로 한다.
- DOMContentLoaded 이벤트는 '스타일시트, 이미지, 하위 프레임의 로딩은 기다리지 않는다'

### 3.4 기준 점수
- 좋은 점수: 2.5초 내
- 보통: 4초 이내
- 나쁜: 4초 이상

### 3.5 개선 방안
- 텍스트는 언제나 옳다: 이미지 대신 문자열
- 이미지는 어떻게 불러올 것인가?
  - <img>: 이미지는 브라우저의 프리로드 스캐너에 의해서 빠르게 요청이 일어난다.
  - <svg> 내부의 <img>: 이미지가 로딩되지 않고, svg만 로딩된 시점에 이미 최대 콘텐츠풀 페인트가 완료된 것으로 간주한다.
  - <video>의 poster: 프리로드 스캐너에 의해 조기 발견
  - background-image: css에 있는 리소스는 느리다.
- 그 밖에 조심해야 할 사항
  - 이미지 무손실 압축
  - loading-lazy 주의
  - fadein과 같은 애니메이션
  - 클라이언트에서 빌드하지 말 것 *
  - 최대 콘텐츠풀 리소스는 직접 호스팅


## 4 최초 입력 지연(FID)

### 4.1 정의
- 사용자가 페이지와 처음 상호 작용할 때(예: 링크를 클릭하거나 버튼을 탭하거나 사용자 지정 JavaScript 기반 컨트롤을 사용할 때)부터 해당 사오 작용에 대한 응답으로 브라우저가 실제로 이벤트 핸들러 처리를 시작하기까지의 시간을 측정합니다.

### 4.2 의미
- 이벤트 반응이 늦어지는 이유: 대부분 브라우저의 메인 스레드가 바쁘기 때문
- 사용자 경험
  - Response: 사용자의 입력에 대한 반응 속도, 50ms 미만으로 처리
  - Animation: 각 프레임을 10ms 이하로 생성
  - idle: 페이지가 50ms 이내에 사용자 입력에 응답
  - Load: 5초 이내에 콘텐츠를 전달하고 인터랙션을 준비할 것

### 4.4 기준 점수
- 좋은 점수: 100ms 이내로 응답
- 보통: 300ms 이내
- 나쁜: 300ms 이후

### 4.5 개선 방안
> #### 실행에 오래 걸리는 긴 작업을 분리
  - 꼭 웹페이지에서 해야 하는 작업인가
  - 긴 작업을 여러 개로 분리하기: Suspense와 lazy 이용
> #### 자바스크립트 코드 최소화
  - 번들링에 필요한 코드만
  - 개발자도구 커버리지 확인
  - 폴리필을 실제 환경에 맞게 꼭 필요한 폴리필만 (SWC)
> #### 타사 자바스크립트 코드 실행의 지연
  - script의 async와 defer 이용
    - defer: 다른 리소스와 병렬로 다운로드
    - async: 다른 리소스와 병렬로 다운로드
    - 둘 다 없는 경우: script를 만나는 순간 다운로드가 우선되며, 다운로드 완료 후 코드 실행


## 5 누적 레이아웃 이동(CLS)

### 5.1 정의
- 페이지의 생명주기 동안 발생하는 모든 예기치 않은 이동에 대한 지표 계산

### 5.2 의미
- 최초 렌더링 이후에 실행되는 useEffect가 많고 렌더링에 영향을 미칠수록 누적 레이아웃 이동에 좋지 못한 점수를 받을 가능성이 커진다.
- 점수 계산에 포함되는 내용
  - 영향분율: 레이아웃 이동이 발생한 요소의 전체 높이와 뷰포트 높이의 비율을 의미
  - 거리분율: 레이아웃 이동이 발생한 요소가 뷰포트 대비 얼마나 이동했는지를 의미
- 스케레톤 UI로 보완

### 5.4 기준 점수
- 좋음: 0.1 이하
- 보통: 0.25 이하
- 나쁜: 그 외

### 5.5 개선 방안
> #### 삽입이 예상되는 요소를 위한 추가적인 공간 확보
> #### 폰트 로딩 최적화
  - 폰트로 발생할 수 있는 문제
    - FOUT: HTML 문서에서 지정한 폰트가 보이지 않고, 대체 기본 폰트로 보이고 있다가 뒤늦게 폰트가 적용되는 현상
    - FOIT: HTML 문서에서 지정한 폰트가 보이지 않고, 기본 폰트도 없어서 텍스트가 없는 채로 있다가 뒤늦게 폰트가 로딩되면서 페이지에 렌더링되는 현상
  - 유의점
    - <link>의 preload 사용: rel=preload
    - font-family: 다섯 가지 방법 (책 참고)
> #### 적절한 이미지 크기 설정
  - width, height 지정
  - 반응형 이미지를 사용하고 싶다면 srcset 속성 사용
  
### 5.6 핵심 웹 지표는 아니지만 성능 확인에 중요한 지표들
> #### 최초 바이트까지의 시간(Time To First Byte, TTTB)
  - 브라우저가 웹페이지의 첫 번째 바이트를 수신하는 데 걸리는 시간
  - 600ms 이상일 경우 개선 필요
  - 고려 사항
    - 서버사이드 렌더링을 수행하고 있다면: 로직 최적화 및 API 최적화
    - 웹페이지의 주된 방문 국적과 가깝게 서버 위치
    - 스트리밍 API를 사용

> #### 최초 콘텐츠풀 페인트(First Contentful Paint, FCP)
  - 페이지가 로드되기 시작한 시점부터 페이지 콘텐츠의 일부가 화면에 렌더링될 때까지의 시간을 측정
  - 좋음: 1.8초 이내, 보통: 3.0초 이내, 개선 필요: 3.0초 이후
  - 고려 사항
    - 최초 바이트까지의 시간 개선
    - 렌더링을 막는 리소스 최소화
    - Above the Fold에 대한 최적화: 가장 먼저 보이는 영역
    - 페이지 리다이렉트 최소화
    - DOM 크기 최소화